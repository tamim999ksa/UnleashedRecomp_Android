name: Release
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      game_data_url:
        description: 'URL or File ID for Game Data ISO (optional)'
        required: false
        type: string
      dlc_data_url:
        description: 'URL or File ID for DLC Data RAR (optional)'
        required: false
        type: string
      title_update_url:
        description: 'URL or File ID for Title Update RAR (optional)'
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-release:
    name: Build Release
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y 7zip
          pip install --upgrade gdown

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: yes | sdkmanager "ndk;25.2.9519653"

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            ./thirdparty/vcpkg/downloads
            ./thirdparty/vcpkg/packages
          key: vcpkg-android-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
              vcpkg-android-

      - name: Bootstrap vcpkg
        run: |
          ./thirdparty/vcpkg/bootstrap-vcpkg.sh

      - name: Build extract-xiso
        run: |
          git clone https://github.com/XboxDev/extract-xiso.git
          cd extract-xiso
          sed -i 's|if ( ( err = mkdir( dir->filename, 0755 ) ) ) mkdir_err( dir->filename );|if ( ( err = mkdir( dir->filename, 0755 ) ) ) { if ( errno != EEXIST ) mkdir_err( dir->filename ); else err = 0; }|' extract-xiso.c
          sed -i 's|if ( ( err = mkdir( iso_name, 0755 ) ) ) mkdir_err( iso_name );|if ( ( err = mkdir( iso_name, 0755 ) ) ) { if ( errno != EEXIST ) mkdir_err( iso_name ); else err = 0; }|' extract-xiso.c
          mkdir build
          cd build
          cmake ..
          make
          sudo make install

      - name: Apply NFD Android Patch
        run: |
          cd thirdparty/nativefiledialog-extended
          if ! grep -q "PLATFORM_ANDROID" CMakeLists.txt; then
            git apply ../../patches/nfd_android.patch
          else
            echo "Patch already applied."
          fi

      - name: Run Build Tools
        run: |
          chmod +x ./build_tools.sh
          ./build_tools.sh

      - name: Cache Assets
        id: cache-assets
        uses: actions/cache@v4
        with:
          path: ./private
          key: game-assets-v1

      - name: Download and Extract Assets
        if: steps.cache-assets.outputs.cache-hit != 'true'
        run: |
          mkdir -p private

          # Download Game Data
          echo "Downloading Game Data..."
          GAME_DATA_URL="${{ inputs.game_data_url }}"
          download_success=false
          if [ -n "$GAME_DATA_URL" ]; then
             echo "Using custom URL for Game Data..."
             if [[ "$GAME_DATA_URL" == *"drive.google.com"* ]] || ! [[ "$GAME_DATA_URL" =~ ^https?:// ]]; then
                 if gdown "$GAME_DATA_URL" -O game_data.iso; then download_success=true; fi
             else
                 if curl -L -o game_data.iso "$GAME_DATA_URL"; then download_success=true; fi
             fi
          else
             echo "Attempting primary download (Google Drive)..."
             for i in {1..3}; do
               if gdown 1QfU4ewEbJoFPYYcaPdmT9Ma1WhR-5jck -O game_data.iso; then
                 download_success=true
                 break
               fi
               sleep 15
             done

             if [ "$download_success" = false ]; then
                 echo "Primary download failed. Attempting secondary download (CDN)..."
                 if curl -L -o game_data.7z "https://cdn.atserver.us/Games/Windows/Sonic%20Unleashed/BASE%20ROM%20%5BADVANCED%5D.7z"; then
                    download_success=true
                 fi
             fi
          fi

          if [ "$download_success" = false ]; then
             echo "Failed to download Game Data."
             exit 1
          fi

          # Download DLC
          echo "Downloading DLC..."
          DLC_DATA_URL="${{ inputs.dlc_data_url }}"
          download_success=false
          if [ -n "$DLC_DATA_URL" ]; then
             echo "Using custom URL for DLC Data..."
             if [[ "$DLC_DATA_URL" == *"drive.google.com"* ]] || ! [[ "$DLC_DATA_URL" =~ ^https?:// ]]; then
                 if gdown "$DLC_DATA_URL" -O dlc_data.rar; then download_success=true; fi
             else
                 if curl -L -o dlc_data.rar "$DLC_DATA_URL"; then download_success=true; fi
             fi
          else
             echo "Attempting primary download (Google Drive)..."
             for i in {1..3}; do
               if gdown 1qnthOSI-rO-M09yN8OigABqRDeTTVSbB -O dlc_data.rar; then
                 download_success=true
                 break
               fi
               sleep 15
             done

             if [ "$download_success" = false ]; then
                 echo "Primary download failed. Attempting secondary download (CDN)..."
                 if curl -L -o dlc_data.7z "https://cdn.atserver.us/Games/Windows/Sonic%20Unleashed/DLC%20%5BADVANCED%5D.7z"; then
                    download_success=true
                 fi
             fi
          fi

          if [ "$download_success" = false ]; then
             echo "Failed to download DLC Data."
             exit 1
          fi

          # Download Title Update
          echo "Downloading Title Update..."
          TITLE_UPDATE_URL="${{ inputs.title_update_url }}"
          download_success=false
          if [ -n "$TITLE_UPDATE_URL" ]; then
             echo "Using custom URL for Title Update..."
             if [[ "$TITLE_UPDATE_URL" == *"drive.google.com"* ]] || ! [[ "$TITLE_UPDATE_URL" =~ ^https?:// ]]; then
                 if gdown "$TITLE_UPDATE_URL" -O title_update.rar; then download_success=true; fi
             else
                 if curl -L -o title_update.rar "$TITLE_UPDATE_URL"; then download_success=true; fi
             fi
          else
             echo "Attempting primary download (Google Drive)..."
             for i in {1..3}; do
               if gdown 1eYsQCzGOtcxxdCSwd7a0WHVbZELrSEEF -O title_update.rar; then
                 download_success=true
                 break
               fi
               sleep 15
             done

             if [ "$download_success" = false ]; then
                 echo "Primary download failed. Attempting secondary download (CDN)..."
                 if curl -L -o title_update.7z "https://cdn.atserver.us/Games/Windows/Sonic%20Unleashed/UPDATE%20%5BADVANCED%5D.7z"; then
                    download_success=true
                 fi
             fi
          fi

          if [ "$download_success" = false ]; then
             echo "Failed to download Title Update."
             exit 1
          fi

          # Process Game Data
          if [ -f game_data.iso ]; then
             echo "Moving Game Data ISO to private/..."
             mv game_data.iso private/
          elif [ -f game_data.7z ]; then
             echo "Extracting Game Data 7z to private/..."
             7z x game_data.7z -oprivate -y
          else
             echo "Error: Game Data not found!"
             exit 1
          fi

          # Process DLC
          echo "Extracting DLC..."
          if [ -f dlc_data.rar ]; then
             7z x dlc_data.rar -oprivate -y
          elif [ -f dlc_data.7z ]; then
             7z x dlc_data.7z -oprivate -y
          else
             echo "Error: DLC Data not found!"
             exit 1
          fi

          # Process Title Update
          echo "Extracting Title Update..."
          if [ -f title_update.rar ]; then
             python3 tools/extract_stfs.py title_update.rar private
          elif [ -f title_update.7z ]; then
             echo "Extracting Title Update 7z..."
             mkdir -p temp_tu
             7z x title_update.7z -otemp_tu -y
             find temp_tu -type f | while read f; do
                echo "Processing extracted file: $f"
                if python3 tools/extract_stfs.py "$f" private; then
                   echo "Successfully extracted STFS package."
                else
                   echo "Not an STFS package, moving to private..."
                   mv "$f" private/
                fi
             done
             rm -rf temp_tu
          else
             echo "Error: Title Update not found!"
             exit 1
          fi

          # Search for and extract ISOs
          echo "Searching for ISOs..."
          find private -name "*.iso" | while read iso_file; do
            echo "Extracting ISO: $iso_file"
            extract-xiso -x "$iso_file" -d private
          done

          echo "Listing private directory contents:"
          ls -R private

      - name: Prepare Project
        run: |
          mkdir -p ./UnleashedRecompLib/private

          if [ -d "./private" ] && [ "$(ls -A ./private)" ]; then
            echo "Listing private directory contents for debugging:"
            find ./private -maxdepth 3

            echo "Searching for default.xex..."
            find ./private -iname "default.xex" -exec cp {} ./UnleashedRecompLib/private/default.xex \;

            echo "Searching for default.xexp..."
            find ./private -iname "default.xexp" -exec cp {} ./UnleashedRecompLib/private/default.xexp \;

            echo "Searching for shader.ar..."
            find ./private -iname "shader.ar" -exec cp {} ./UnleashedRecompLib/private/shader.ar \;
          else
            echo "Private directory is empty or does not exist."
          fi

          if [ ! -f "./UnleashedRecompLib/private/default.xex" ]; then
            echo "Error: default.xex not found in UnleashedRecompLib/private/ or ASSET_REPO."
            exit 1
          fi
          if [ ! -f "./UnleashedRecompLib/private/default.xexp" ]; then
            echo "Error: default.xexp not found in UnleashedRecompLib/private/ or ASSET_REPO."
            exit 1
          fi
          if [ ! -f "./UnleashedRecompLib/private/shader.ar" ]; then
            echo "Error: shader.ar not found in UnleashedRecompLib/private/ or ASSET_REPO."
            exit 1
          fi

          echo "Assets prepared successfully."
          ls -l ./UnleashedRecompLib/private/

      - name: Build Release APK
        working-directory: ./android
        run: ./gradlew assembleRelease

      - name: Upload Release Asset
        if: github.event_name == 'release'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ github.event.release.tag_name }} android/app/build/outputs/apk/release/app-release.apk --clobber

      - name: Upload Artifact
        if: github.event_name != 'release'
        uses: actions/upload-artifact@v4
        with:
          name: UnleashedRecomp-Android-Release
          path: android/app/build/outputs/apk/release/app-release.apk
